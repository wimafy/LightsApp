"use strict";angular.module("angularfireSlackApp",["firebase","angular-md5","ui.router","ngMaterial","ngMessages"]).config(["$stateProvider","$urlRouterProvider",function(a,b){a.state("login",{url:"/",controller:"AuthCtrl as authCtrl",templateUrl:"auth/login.html",resolve:{requireNoAuth:["$state","Auth",function(a,b){return b.$requireSignIn().then(function(b){a.go("home")},function(a){})}]}}).state("home",{url:"/home",templateUrl:"home/home.html",resolve:{requireNoAuth:["$state","Auth",function(a,b){return b.$requireSignIn().then(function(b){a.go("channels")},function(a){})}]}}).state("register",{url:"/register",controller:"AuthCtrl as authCtrl",templateUrl:"auth/register.html",resolve:{requireNoAuth:["$state","Auth",function(a,b){return b.$requireSignIn().then(function(b){a.go("login")},function(a){})}]}}).state("profile",{url:"/profile",controller:"ProfileCtrl as profileCtrl",templateUrl:"users/profile.html",resolve:{auth:["$state","Users","Auth",function(a,b,c){return c.$requireSignIn().catch(function(){a.go("login")})}],profile:["Users","Auth",function(a,b){return b.$requireSignIn().then(function(b){return a.getProfile(b.uid).$loaded()})}]}}).state("channels",{url:"/channels",controller:"ChannelsCtrl as channelsCtrl",templateUrl:"channels/index.html",resolve:{channels:["Channels",function(a){return a.$loaded()}],profile:["$state","Auth","Users",function(a,b,c){return b.$requireSignIn().then(function(b){return c.getProfile(b.uid).$loaded().then(function(b){return b.displayName?b:void a.go("profile")})},function(b){a.go("home")})}]}}).state("mainpage",{url:"/mainpage",controller:"MainPageCtrl as mainpageCtrl",templateUrl:"mainpage/mainpage.html",resolve:{channels:["Channels",function(a){return a.$loaded()}],profile:["$state","Auth","Users",function(a,b,c){return b.$requireSignIn().then(function(b){return c.getProfile(b.uid).$loaded().then(function(b){return b.displayName?b:void a.go("profile")})},function(b){a.go("home")})}]}}).state("newproject",{url:"/newproject",controller:"ProjectsCtrl as projectsCtrl",templateUrl:"projects/projectNew.html",resolve:{profile:["$state","Auth","Users",function(a,b,c){return b.$requireSignIn().then(function(b){return c.getProfile(b.uid).$loaded().then(function(b){return b.displayName?b:void a.go("profile")})},function(b){a.go("home")})}]}}).state("channels.create",{url:"/create",templateUrl:"channels/create.html",controller:"ChannelsCtrl as channelsCtrl"}).state("channels.messages",{url:"/{channelId}/messages",templateUrl:"channels/messages.html",controller:"MessagesCtrl as messagesCtrl",resolve:{messages:["$stateParams","Messages",function(a,b){return b.forChannel(a.channelId).$loaded()}],channelName:["$stateParams","channels",function(a,b){return"#"+b.$getRecord(a.channelId).name}]}}).state("channels.direct",{url:"/{uid}/messages/direct",templateUrl:"channels/messages.html",controller:"MessagesCtrl as messagesCtrl",resolve:{messages:["$stateParams","Messages","profile",function(a,b,c){return b.forUsers(a.uid,c.$id).$loaded()}],channelName:["$stateParams","Users",function(a,b){return b.all.$loaded().then(function(){return"@"+b.getDisplayName(a.uid)})}]}}),b.otherwise("/")}]).config(function(){var a={apiKey:"AIzaSyBc6yn3_ydeKJ6ioDSPzkPfBqzkEff1BuA",authDomain:"lightsapp-b03f4.firebaseapp.com",databaseURL:"https://lightsapp-b03f4.firebaseio.com",storageBucket:"lightsapp-b03f4.appspot.com",messagingSenderId:"1022638520289"};firebase.initializeApp(a)}),angular.module("angularfireSlackApp").controller("AuthCtrl",["Auth","$state",function(a,b){var c=this;c.user={email:"",password:""},c.login=function(){a.$signInWithEmailAndPassword(c.user.email,c.user.password).then(function(a){b.go("home")},function(a){c.error=a})},c.register=function(){a.$createUserWithEmailAndPassword(c.user.email,c.user.password).then(function(a){b.go("home")},function(a){c.error=a})}}]),angular.module("angularfireSlackApp").factory("Auth",["$firebaseAuth",function(a){var b=a();return b}]),angular.module("angularfireSlackApp").factory("Users",["$firebaseArray","$firebaseObject",function(a,b){var c=firebase.database().ref("users"),d=firebase.database().ref(".info/connected"),e=a(c),f={getProfile:function(a){return b(c.child(a))},getDisplayName:function(a){return e.$getRecord(a).displayName},getGravatar:function(a){return"//www.gravatar.com/avatar/"+e.$getRecord(a).emailHash},setOnline:function(e){var f=b(d),g=a(c.child(e+"/online"));f.$watch(function(){f.$value===!0&&g.$add(!0).then(function(a){a.onDisconnect().remove()})})},all:e};return f}]),angular.module("angularfireSlackApp").controller("ProfileCtrl",["$state","md5","auth","profile",function(a,b,c,d){var e=this;e.profile=d,e.updateProfile=function(){e.profile.emailHash=b.createHash(c.email),e.profile.$save().then(function(){a.go("channels")})}}]),angular.module("angularfireSlackApp").controller("ChannelsCtrl",["$state","Auth","Users","profile","channels",function(a,b,c,d,e){var f=this;f.profile=d,f.channels=e,f.getDisplayName=c.getDisplayName,f.getGravatar=c.getGravatar,f.users=c.all,c.setOnline(f.profile.$id),f.newChannel={name:""},f.createChannel=function(){f.channels.$add(f.newChannel).then(function(b){a.go("channels.messages",{channelId:b.key})})},f.logout=function(){f.profile.online=null,f.profile.$save().then(function(){b.$signOut().then(function(){a.go("login")})})}}]),angular.module("angularfireSlackApp").factory("Channels",["$firebaseArray",function(a){var b=firebase.database().ref("channels"),c=a(b);return c}]),angular.module("angularfireSlackApp").controller("ProjectsCtrl",["$state","$timeout","Auth","Users","profile","projects",function(a,b,c,d,e,f){var g=this;g.profile=e,g.projects=f,g.getDisplayName=d.getDisplayName,g.getGravatar=d.getGravatar,g.users=d.all,d.setOnline(g.profile.$id),g.newProject={name:"",songurl:"",user:g.profile.$id},g.colorList=["#d32f2f","#C2185B","#7B1FA2","#512DA8","#303F9F","#0288D1","#1976D2","#0097A7","#00796B","#388E3C","#689F38","#AFB42B","#FBC02D","#FFA000","#F57C00","#E64A19","#5D4037","#616161","#455A64"],g.selectedColor="#d32f2f",g.selectColor=function(a){g.selectedColor=a},$("#file").on("change",function(a){selectedFile=a.target.files[0]}),g.percentage=0,g.newProject.songurl="null",g.uploadFile=function(a){var b=selectedFile.name,c=firebase.storage().ref("/projectSongs/"+b),d=c.put(selectedFile);d.on("state_changed",function(a){var b=a.bytesTransferred/a.totalBytes*100;g.percentage=b},function(a){},function(){var a=firebase.database().ref("Songs/").push().key,b=d.snapshot.downloadURL,c={},e={url:b,user:g.profile.$id};c["/Songs/"+g.profile.$id+"/"+a]=e,firebase.database().ref().update(c),g.newProject.songurl=b})},g.songurlLoop=function(){if("null"==g.newProject.songurl)b(function(){g.songurlLoop()},1e3);else{var c=firebase.database().ref("Projects/"+g.profile.$id).push().key,d={};d["/Projects/"+g.profile.$id+"/"+c]=g.newProject,firebase.database().ref().update(d).then(function(b){a.go("mainpage")})}},g.createProject=function(){g.uploadFile(),g.songurlLoop()},g.logout=function(){g.profile.online=null,g.profile.$save().then(function(){c.$signOut().then(function(){a.go("login")})})}}]),angular.module("angularfireSlackApp").factory("projects",["$firebaseArray",function(a){var b=firebase.auth().currentUser.uid,c=firebase.database().ref("/Projects/"+b),d=a(c);return d}]),angular.module("angularfireSlackApp").controller("MainPageCtrl",["$state","Auth","Users","profile","projects",function(a,b,c,d,e){var f=this;f.profile=d,f.projects=e,f.getDisplayName=c.getDisplayName,f.getGravatar=c.getGravatar,f.users=c.all,c.setOnline(f.profile.$id),f.newProject={name:""},f.logout=function(){f.profile.online=null,f.profile.$save().then(function(){b.$signOut().then(function(){a.go("login")})})}}]),angular.module("angularfireSlackApp").factory("Messages",["$firebaseArray",function(a){var b=firebase.database().ref("channelMessages"),c=firebase.database().ref("userMessages");return{forChannel:function(c){return a(b.child(c))},forUsers:function(b,d){var e=b<d?b+"/"+d:d+"/"+b;return a(c.child(e))}}}]),angular.module("angularfireSlackApp").controller("MessagesCtrl",["profile","channelName","messages",function(a,b,c){var d=this;d.messages=c,d.channelName=b,d.message="",d.sendMessage=function(){d.message.length>0&&d.messages.$add({uid:a.$id,body:d.message,timestamp:firebase.database.ServerValue.TIMESTAMP}).then(function(){d.message=""})}}]);